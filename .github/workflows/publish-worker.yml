name: Publish Cloudflare Worker

on:
  push:
    branches: [ main ]
  workflow_dispatch: {}

jobs:
  publish-worker:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install Wrangler (v3+)
        run: npm install -g wrangler@latest

      - name: Deploy Worker
        working-directory: ./worker
        env:
          # Prefer CLOUDFLARE_API_TOKEN; fall back to CF_API_TOKEN for compatibility
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CF_API_TOKEN: ${{ secrets.CF_API_TOKEN }}
          # Account/zone are defined in wrangler.toml; exporting for clarity
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CF_ACCOUNT_ID }}
          CF_ACCOUNT_ID: ${{ secrets.CF_ACCOUNT_ID }}
          CF_ZONE_ID: ${{ secrets.CF_ZONE_ID }}
        run: |
          # Authenticate using CLOUDFLARE_API_TOKEN (Wrangler v3+). If only CF_API_TOKEN
          # is present, promote it to CLOUDFLARE_API_TOKEN to avoid deprecation warnings.
          if [ -z "${CLOUDFLARE_API_TOKEN}" ] && [ -n "${CF_API_TOKEN}" ]; then
            export CLOUDFLARE_API_TOKEN="${CF_API_TOKEN}"
          fi
          # Account/zone are already set in worker/wrangler.toml; env vars here are optional.
          wrangler deploy

      - name: Post-publish smoke test (optional)
        if: always()
        working-directory: ./worker
        env:
          TEST_WEBHOOK_URL: ${{ secrets.TEST_WEBHOOK_URL }}
        run: |
          # This step is optional. If you set the repo secret TEST_WEBHOOK_URL to a full
          # test webhook URL (for example: https://test-sub.daxlinksonline.link/webhook),
          # the workflow will POST a small JSON payload to exercise the ingress path.
          if [ -z "$TEST_WEBHOOK_URL" ]; then
            echo "No TEST_WEBHOOK_URL secret set â€” skipping smoke test.";
            exit 0;
          fi

          echo "Running smoke test against $TEST_WEBHOOK_URL"
          set -o pipefail
          curl -sS -X POST "$TEST_WEBHOOK_URL" -H 'Content-Type: application/json' -d '{"test":"ping","ts":'"$(date +%s)"'}' -w "\nHTTP_CODE:%{http_code}\n" | tee smoke_response.log
          # treat any 2xx/3xx as success; otherwise fail the step
          code=$(tail -n1 smoke_response.log | sed -n 's/.*HTTP_CODE:\([0-9]*\)/\1/p') || code=0
          echo "Smoke test returned HTTP $code"
          if [ "$code" -ge 200 -a "$code" -lt 400 ]; then
            echo "Smoke test passed";
            exit 0;
          else
            echo "Smoke test failed (HTTP $code)";
            exit 1;
          fi
